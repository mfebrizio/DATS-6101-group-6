---
title: "Technical Analysis"
author: "Team 6"
#date: "3/23/2022"
date: "`r Sys.Date()`"
output:
  html_document:
    code_folding: hide
    number_sections: false
    toc: yes
    toc_depth: 3
    toc_float: yes
  pdf_document:
    toc: yes
    toc_depth: '3'
---

```{r init, include=F}

# Import libraries
library(ezids)
library(dplyr)
library(data.table)
#library(readr)
library(lattice)
library(corrplot)

```


```{r setup, include=FALSE}

# knitr::opts_chunk$set(warning = F, results = "markup", message = F)
knitr::opts_chunk$set(warning = F, results = "hide", message = F, echo = TRUE)
options(scientific=T, digits = 3) 
# options(scipen=9, digits = 3) 
# ‘scipen’: integer. A penalty to be applied when deciding to print numeric values in fixed or exponential notation.  Positive values bias towards fixed and negative towards scientific notation: fixed notation will be preferred unless it is more than ‘scipen’ digits wider.
# use scipen=999 to prevent scientific notation at all times


```


# Technical Analysis

## Instructions

Technical analysis (R code), 25% (First attempt due: Mar 28 Monday 12:30pm)

Just before your team presentation, provide an R-markdown, or R script file, which shows the R-code and brief explanations as well as the rationale of the Exploratory Data Analysis of
your project. (Also submit your data file, or give the online source url.) This submission,
together with your final document (in part VI), will determine your team’s grade. This
document shows a technical person the math/stat/codes that you used in your analysis. It
should include:  
- Summary of the dataset
- Descriptive Statistics
- Graphical representations of the data
- [When applicable] Measures of Variance / sd
- [When applicable] Normality tests
- [When applicable] Initial correlation / Chi Square tests / ANOVA analysis / Z-test or Z-interval / T-test or T-interval etc.


## Summary

**Assigned to:** Mark

```{r import, results='hide', echo=F}

# import csv as dataframe
dframe <- data.frame(read.csv("data/processed/analytic_data_2016_2021_with_regions.csv"))

# convert variables to factor
dframe$region <- factor(dframe$region)
dframe$division <- factor(dframe$division)
dframe$statecode <- factor(dframe$statecode)
dframe$countycode <- factor(dframe$countycode)
dframe$fipscode <- factor(dframe$fipscode)
dframe$county_ranked <- factor(dframe$county_ranked)

# check structure of data
str(dframe)
summary(dframe)

```

```{r summary, results='hide'}

# look at county_ranked var; not all counties are ranked; also some aggregated data per state and country exist in the observations
# =1 means they are ranked, =0 means unranked, and =NA is for state/national data
print(summary(dframe$county_ranked))

# subset of dataframe including only ranked counties
ranked <- dframe %>% subset(county_ranked==1)

# subset of dataframe including only ranked counties
unranked <- dframe %>% subset(county_ranked==0)

# subset of dataframe including only aggregated data
aggregated <- dframe %>% subset(is.na(county_ranked))

# subset ranked data into annual datasets
ranked16 <- ranked %>% subset(year==2016)
ranked17 <- ranked %>% subset(year==2017)
ranked18 <- ranked %>% subset(year==2018)
ranked19 <- ranked %>% subset(year==2019)
ranked20 <- ranked %>% subset(year==2020)
ranked21 <- ranked %>% subset(year==2021)

# view size of annual datasets
df_annual_list <- list(ranked16, ranked17, ranked18, ranked19, ranked20, ranked21)
for (df in df_annual_list) {
  print(paste("Observations in", median(df$year), "data: ", nrow(df)))
  
}

```

Our data are identified at the county-year level. Our data set contains `r nrow(dframe)` observations and `r ncol(dframe)` variables, although `r nrow(aggregated)` of these observations are for aggregated data at the national or state level. In addition, `r nrow(unranked)` observations are for counties that are unranked by the [University of Wisconsin Population Health Institute](https://www.countyhealthrankings.org/explore-health-rankings/faq-page), suggesting that the data for these counties is less reliable.

In total, we have `r nrow(ranked)` observations in the ranked data, combined across 6 annual reports (2016–2021). Each annual data set has between 3071 and 3084 observations, indicating that the number of ranked counties is consistent over time.

```{r ranked, results='markup'}

# view head and tail of ranked data
xkabledplyhead(ranked, 5, title = "Table: First 5 Rows of Ranked Data")
xkabledplytail(ranked, 5, title = "Table: Last 5 Rows of Ranked Data")

# groupby year
ranked_by_year <- ranked %>% group_by(year)

summ_by_year <- ranked_by_year %>%  summarize(num_counties = n_distinct(fipscode), 
                              num_states = n_distinct(statecode),
                              wmean_inequality = weighted.mean(inequality, pop, na.rm=T), 
                              wmean_mh_rate = weighted.mean(mental_distress_rate, pop, na.rm=T), 
                              wmean_mh_days = weighted.mean(mental_health_days, pop, na.rm=T), 
                              wmean_unempl = weighted.mean(unempl, pop, na.rm=T), 
                              wmean_medinc = weighted.mean(median_inc, pop, na.rm=T),
                              )

summ_by_year

# groupby year and state
ranked_by_year_state <- ranked %>% group_by(year, statecode)

summ_by_year_state <- ranked_by_year_state %>% summarize(num_obs = n(), 
                                   state_name = first(state),
                                   wmean_inequality = weighted.mean(inequality, pop, na.rm = T),
                                   wmean_mh_rate = weighted.mean(mental_distress_rate, pop, na.rm=T),
                                   wmean_mh_days = weighted.mean(mental_health_days, pop, na.rm=T)
                                   )

summ_by_year_state

```


## Descriptive Statistics

**Assigned to:** Alex

```{r dstats, results='markup'}

summary()
xkablesummary()


```


## Graphs and Figures

**Assigned to:** Mark (with help from Shumel & Xuan)

For example, histograms, boxplots, scatterplots, line graphs (for aggregated annual data), etc. We should use the `ggplot()` function.

```{r graphs_init, results='hide'}

loadPkg("ggplot2")
loadPkg("patchwork") ## for combining graphs
loadPkg("purrr")
loadPkg("tidyr")
loadPkg("gridExtra")

```

```{r lines_annual, results='markup'}

# use summ_by_year

# annual trends for mental health var
p1 <- ggplot(summ_by_year, aes(x=year)) +
  geom_line(aes(y = wmean_mh_days), lwd=1) + 
  expand_limits(y=c(0,5)) +
  labs(title = "Poor Mental Health Days", 
       x = "Report Year", y = "Avg for past 30 days") +
  theme_minimal()

p2 <- ggplot(summ_by_year, aes(x=year)) +
  geom_line(aes(y = wmean_mh_rate), lwd=1) + 
  expand_limits(y=c(0,.2)) +
  labs(title = "Frequent Mental Distress Rate", 
       x = "Report Year", y = "Percentage of adults") + 
  theme_minimal()

# combine plots using patchwork package
p1 + p2

# annual trends for inequality and median income
p3 <- ggplot(summ_by_year, aes(x=year)) +
  geom_line(aes(y = wmean_inequality), lwd=1) + 
  expand_limits(y=c(0,5)) +
  labs(title = "Income Inequality", 
       x = "Report Year", y = "Ratio 80th : 20th pctl") +
  theme_minimal()

p4 <- ggplot(summ_by_year, aes(x=year)) +
  geom_line(aes(y = wmean_medinc / 1000), lwd=1) + 
  expand_limits(y=c(0,max(summ_by_year$wmean_medinc/1000)+5)) +
  labs(title = "Median Income", 
       x = "Report Year", y = "Thousands of Dollars") +
  theme_minimal()

p5 <- ggplot(summ_by_year, aes(x=year)) +
  geom_line(aes(y = wmean_unempl), lwd=1) + 
  expand_limits(y=c(0,.10)) +
  labs(title = "Unemployment Rate", 
       x = "Report Year", y = "Percent unemployed") +
  theme_minimal()

# combine plots
p3 / (p4 + p5)

```

```{r scatter_a, results='markup'}

# data: use ranked
colnames(ranked)

#-- Dependent vs Explanatory --#

# color = median income
ggplot(ranked, aes(y=mental_health_days, x=inequality, color=median_inc/1000)) + 
  geom_point() +
  geom_smooth(formula = y ~ x, method=lm, se=FALSE, color="#a89968") +  ## Add linear regression line
  labs(title = "Scatterplot of Poor Mental Health Days vs. Inequality",
       y = 'Poor mental health days per 30', x = 'Income inequality rate', 
       color = "Median Income ($ Thous.)")

ggplot(ranked, aes(y=mental_distress_rate, x=inequality, color=median_inc/1000)) + 
  geom_point() +
  geom_smooth(formula = y ~ x, method=lm, se=FALSE, color="#a89968") + 
  labs(title = "Scatterplot of Frequent Distress vs. Inequality",
       y = 'Mental distress rate', x = 'Income inequality rate', 
       color = "Median Income ($ Thous.)")

# color = % rural
ggplot(ranked, aes(y=mental_health_days, x=inequality, color=pct_rural)) + 
  geom_point() +
  geom_smooth(formula = y ~ x, method=lm, se=FALSE, color="#a89968") +  ## Add linear regression line
  labs(title = "Scatterplot of Poor Mental Health Days vs. Inequality",
       y = 'Poor mental health days per 30', x = 'Income inequality rate', 
       color = "% Rural Pop.")

ggplot(ranked, aes(y=mental_distress_rate, x=inequality, color=pct_rural)) + 
  geom_point() +
  geom_smooth(formula = y ~ x, method=lm, se=FALSE, color="#a89968") + 
  labs(title = "Scatterplot of Frequent Distress vs. Inequality",
       y = 'Mental distress rate', x = 'Income inequality rate', 
       color = "% Rural Pop.")


#-- Dependent vs. Provision of Mental Health Care --#

# color = % rural
ggplot(ranked, aes(y=mental_health_days, x=pop_provider_ratio, color=pct_rural)) + 
  geom_point() +
  geom_smooth(formula = y ~ x, method=lm, se=FALSE, color="#a89968") + 
  labs(title = "Scatterplot of Poor Mental Health Days vs. Mental Health Providers",
       y = 'Mental distress rate', x = 'Ratio population : providers', 
       color = "% Rural Pop.")

ggplot(ranked, aes(y=mental_distress_rate, x=pop_provider_ratio, color=pct_rural)) + 
  geom_point() +
  geom_smooth(formula = y ~ x, method=lm, se=FALSE, color="#a89968") + 
  labs(title = "Scatterplot of Frequent Distress vs. Mental Health Providers",
       y = 'Mental distress rate', x = 'Ratio population : providers', 
       color = "% Rural Pop.")


#-- Inequality vs. other economic variables --#

# unempl, child_poverty, hs_grad, college, single_parent, severe_housing, food_index

gg1 <- ggplot(ranked, aes(y=inequality, x=unempl)) + 
  geom_point() + 
  geom_smooth(formula = y ~ x, method=lm, se=FALSE) + 
  labs(title = "Plot (a)")

gg2 <- ggplot(ranked, aes(y=inequality, x=severe_housing)) + 
  geom_point() +
  geom_smooth(formula = y ~ x, method=lm, se=FALSE) + 
  labs(title = "Plot (b)")

gg3 <- ggplot(ranked, aes(y=inequality, x=child_poverty)) + 
  geom_point() +
  geom_smooth(formula = y ~ x, method=lm, se=FALSE) + 
  labs(title = "Plot (c)")

gg4 <- ggplot(ranked, aes(y=inequality, x=single_parent)) + 
  geom_point() +
  geom_smooth(formula = y ~ x, method=lm, se=FALSE) + 
  labs(title = "Plot (d)")

gg5 <- ggplot(ranked, aes(y=inequality, x=hs_grad)) + 
  geom_point() +
  geom_smooth(formula = y ~ x, method=lm, se=FALSE) + 
  labs(title = "Plot (e)")

gg6 <- ggplot(ranked, aes(y=inequality, x=college)) + 
  geom_point() +
  geom_smooth(formula = y ~ x, method=lm, se=FALSE) + 
  labs(title = "Plot (f)")

gg7 <- ggplot(ranked, aes(y=inequality, x=food_index)) + 
  geom_point() +
  geom_smooth(formula = y ~ x, method=lm, se=FALSE) + 
  labs(title = "Plot (g)")

plot_list <- list(gg1, gg2, gg3, gg4, gg5, gg6, gg7)

do.call("grid.arrange", c(plot_list, ncol = 3))

```

```{r scatter_b, results='markup'}

# use ranked

colnames(rankedreg)
str(rankedreg)
rankedreg %>% subset(is.na(region))
rankedreg %>% subset(statecode==46 & countycode==113)


# generate scatterplot using ggplot
ggplot(rankedreg, aes(y=mental_health_days, x=inequality, color = factor(region))) + 
  geom_point() +
  labs(title = paste("Scatterplot of Poor Mental Health Days vs. Inequality"),
       y = 'Poor mental health days per 30', x = 'Income inequality rate', 
       color = "Region")


#mental_distress_rate
# generate scatterplot using ggplot
ggplot(rankedreg, aes(y=mental_distress_rate, x=inequality, color = factor(region))) + 
  geom_point() + 
  labs(title = paste("Scatterplot of Mental Distress vs. Inequality"),
       y = 'Mental distress rate', x = 'Income inequality rate', 
       color = "Region")



```


```{r hist_multiple, results='markup'}

# https://www.r-bloggers.com/2016/07/quick-plot-of-all-variables/

keep_var <- c('inequality', 'unempl', 'child_poverty', 'hs_grad', 'college', 'single_parent', 'severe_housing', 'food_index', 'mental_health_days', 'mental_distress_rate', 'median_inc')

#ranked[keep_var]

ranked[keep_var] %>% 
  gather() %>% 
  ggplot(aes(x=value)) + 
    facet_wrap(~ key, scales = "free") + 
    geom_histogram(bins=50)



```


```{r histograms, results='markup'}

# Shumel -- please work on some histograms


```


```{r boxplots, results='markup'}

# Xuan -- please work on some boxplots


```




## Measures of Variation
*When applicable.*

**Assigned to:** Xuan

Variance, standard deviation, etc.

```{r variance, results='markup'}


```


## Normality tests
*When applicable.*

**Assigned to:** Shumel

For example, histograms, Q-Q plots, etc. Try `ezids::outlierKD2()` function if necessary.

```{r norm, results='markup'}

qqnorm()
qqline()

```



## Initial Correlation and Hypothesis Tests
*When applicable.*

**Assigned to:** Alex (with help from Mark)

For example, Chi Square tests, ANOVA analysis, Z-test or Z-interval, T-test or T-interval, etc.

```{r corr, results='markup'}

t.test()

table() ## creates contingency table
chisq.test()

aov(y ~ x, data=)


pairs()
cor() ## correlation matrix
corrplot()


```



## Linear Modeling and Regression
*When applicable. Might not need at all.*

**Assigned to:** TBD

```{r reg, results='markup'}

lm()
xkablevif()
anova()
xkabledply()


```

