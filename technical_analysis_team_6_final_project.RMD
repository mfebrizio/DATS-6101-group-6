---
title: "Final Project Technical Analysis"
author: "Team 6"
date: "`r Sys.Date()`"
output:
  html_document:
    code_folding: hide
    number_sections: false
    toc: yes
    toc_depth: 3
    toc_float: yes
---

```{r setup, include=FALSE}

# knitr::opts_chunk$set(warning = F, results = "markup", message = F)
knitr::opts_chunk$set(
	echo = TRUE,
	message = FALSE,
	warning = FALSE,
	results = "hide"
)
options(scientific=T, digits = 3) 
# options(scipen=9, digits = 3) 
# ‘scipen’: integer. A penalty to be applied when deciding to print numeric values in fixed or exponential notation.  Positive values bias towards fixed and negative towards scientific notation: fixed notation will be preferred unless it is more than ‘scipen’ digits wider.
# use scipen=999 to prevent scientific notation at all times

# Import libraries
library(ezids)
library(dplyr)
#library(corrplot)
#library(broom)
#loadPkg("ggplot2")
#loadPkg("patchwork") ## for combining graphs
#loadPkg("purrr")
#loadPkg("gridExtra")

```

# Instructions

Technical analysis (R code), 25%. First attempt due on May 1 Sunday, the same time as as
your team’s video presentation. Provide an R-markdown, or R script file, which shows
the R-code and brief explanations as well as the rationale of the EDA and models you used.
This submission, together with your final document (in part VI), will determine your
team’s grade. This document shows a technical person the math/stat/codes that you used in
your analysis. It should include:

- Codes of any models that you built
- Graph and chart outputs with your R codes
- [When applicable] Codes of any statistical tests you used
- Model evaluation(s) and comparison


# Topic Proposal

The results of our midterm project indicated that there was a relationship between income inequality and
mental health, which varied geographically across regions of the U.S. In this next stage, we intend to use
statistical models to better understand the strength of the relationship.

We plan to build a linear regression model that assesses the strength of this relationship. Our independent
variable for measuring income inequality is the “ratio of household income at the 80th percentile to
income at the 20th percentile.” We have two alternative measures of mental health that can be used as
dependent variables: the rate of frequent mental distress and the average number of poor mental health
days reported in the past 30 days. We also plan to include additional variables that are expected to affect
mental health, including median household income, the percentage of households with severe housing
problems, the unemployment rate, the child poverty rate, and county-level demographic information.
Additionally, regression tree and random forest models will be used to determine variable importance and
better predict the prevalence of mental health issues.

This discussion provokes the following SMART questions:

- Is the relationship between mental health and income inequality across U.S. counties robust when
including other economic variables?
- Does the relationship differ across regions of the U.S.?
- Does the relationship depend on the measure used for mental health?


# Description of the Dataset

The primary dataset used for this project is a combination of annual datasets called the County Health Rankings and Roadmaps National Data and was obtained the Robert Wood Johnson Foundation (RWJF). The County Health Rankings and Roadmaps National Data consists of county-level socioeconomic and public health data. The reports published from 2016 to 2021 provided the most complete data for all the variables of interest. The annual datasets before 2016 were incomplete or did not have variables that exactly corresponded to variables in 2016 to 2021. In general, the years in the datasets reflect the year the report was released by RWJF, but the underlying source data are from a one or two calendar years earlier.

For the exploratory data analysis, the data was also separated into four regions defined by the U.S. Census Bureau (U.S. Census Bureau, 2010).   

The variables in the data set are:

* `region`: name of the US Census Bureau region (name)
* `division`: name of the US Census Bureau division (contained with a census region)
* `state`: two letter state abbreviation
* `statecode`: FIPS state code
* `countycode`: FIPS county code
* `fipscode`: 5-digit FIPS Code (county-level); combines `statecode` and `countycode`
* `county`: county name
* `year`: report release year from [County Health Rankings](https://www.countyhealthrankings.org/); range of 2016-2021
* `county_ranked`: Indicates whether or not the county was ranked; 0=unranked, 1=ranked, or NA for aggregated national or state-level data
* `mental_health_days`: Average number of mentally unhealthy days reported in past 30 days (age-adjusted)
* `mental_distress_rate`: Percentage of adults reporting 14 or more days of poor mental health per month
* `inequality`: Ratio of household income at the 80th percentile to income at the 20th percentile (Income inequality)
* `median_inc`: The income where half of households in a county earn more and half of households earn less
* `hs_grad`: Percentage of adults ages 25 and over with a high school diploma or equivalent
* `college`: Percentage of adults ages 25-44 with some post-secondary education
* `unempl`: Percentage of population ages 16 and older unemployed but seeking work
* `child_poverty`: Percentage of people under age 18 in poverty
* `single_parent`: Percentage of children that live in a household headed by single parent
* `severe_housing`: Percentage of households with severe housing problems
* `food_index`: Index of factors that contribute to a healthy food environment, from 0 (worst) to 10 (best)
* `mh_providers`: rate of providers to 100,000 population
* `pop_provider_ratio`: ratio of population to mental health providers (i.e., population served per provider)
* `pop`: census population estimate
* `pct_below18`: percent of population younger than 18
* `pct_black`: percent of population that are African-American or non-Hispanic Black
* `pct_native_am`: percent of population that are Native American or Alaska Natives
* `pct_asian`: percent of population that are Asian
* `pct_pacific`: percent of population that are Native Hawaiian or Other Pacific Islander
* `pct_hispanic`: percent of population that are Hispanic
* `pct_white`: percent of population that are non-Hispanic white or Caucasian
* `pct_female`: percent of population that are female
* `pct_rural`: percent of population that live in rural areas

```{r import, results='hide', echo=F}

# import csv as dataframe
dframe <- data.frame(read.csv("data/processed/analytic_data_2016_2021_with_regions.csv"))
#View(dframe)

# convert variables to factor
dframe$region <- factor(dframe$region)
dframe$division <- factor(dframe$division)
dframe$statecode <- factor(dframe$statecode)
dframe$countycode <- factor(dframe$countycode)
dframe$fipscode <- factor(dframe$fipscode)
dframe$county_ranked <- factor(dframe$county_ranked)
dframe$year <- factor(dframe$year)

# check structure of data
str(dframe)
```

```{r subset, results='hide'}

# look at county_ranked var; not all counties are ranked; also some aggregated data per state and country exist in the observations
# =1 means they are ranked, =0 means unranked, and =NA is for state/national data
#print(summary(dframe$county_ranked))

# subset of dataframe including only ranked counties
ranked <- dframe %>% subset(county_ranked==1)

# subset of dataframe including only ranked counties
unranked <- dframe %>% subset(county_ranked==0)

# subset of dataframe including only aggregated data
aggregated <- dframe %>% subset(is.na(county_ranked))

# duplicate column and rename level labels for easier reading
ranked$region_abb <- ranked$region
levels(ranked$region_abb) <- c("", 
                              "MW",  # re-level factor labels
                              "NE",
                              "S", 
                              "W")

# subset ranked data by region
ranked_MW <- ranked %>% subset(region=="Midwest")
ranked_NE <- ranked %>% subset(region=="Northeast")
ranked_SO <- ranked %>% subset(region=="South")
ranked_WE <- ranked %>% subset(region=="West")

# subset ranked data into annual datasets
ranked16 <- ranked %>% subset(year==2016)
ranked17 <- ranked %>% subset(year==2017)
ranked18 <- ranked %>% subset(year==2018)
ranked19 <- ranked %>% subset(year==2019)
ranked20 <- ranked %>% subset(year==2020)
ranked21 <- ranked %>% subset(year==2021)

# sort dataframe
ranked <- ranked[order(ranked$year, ranked$region, ranked$division, ranked$statecode, ranked$countycode), ]

```

Our data are identified at the county-year level. Our data set contains `r nrow(dframe)` observations and `r ncol(dframe)` variables, although `r nrow(aggregated)` of these observations are for aggregated data at the national or state level. In addition, `r nrow(unranked)` observations are for counties that are unranked by [RWJF](https://www.countyhealthrankings.org/explore-health-rankings/faq-page), suggesting that the data for these counties is less reliable. In total, we have `r nrow(ranked)` observations in the ranked data, combined across 6 annual reports (2016–2021). Each annual data set has between 3071 and 3084 observations, indicating that the number of ranked counties is consistent over time.


# Exploratory Data Analysis

Summarize from Midterm Project.


# Models and Statistical Tests

## Linear Models

We assessed two sets of models with different dependent variables. The first set of models used `mental_health_days` as the dependent variable, while the second set used `mental_distress_rate` as the dependent variable.

### Dependent variable: `mental_health_days`



```{r lm_days, results='markup'}

# v1: base model
lm_days_1 <- lm(mental_health_days ~ inequality + region, data = ranked)
summary(lm_days_1)
xkablevif(lm_days_1)

# v2: include year as factor variable
lm_days_2 <- lm(mental_health_days ~ inequality + region + year, data = ranked)
summary(lm_days_2)
xkablevif(lm_days_2)

# v3: include economic vars
lm_days_3 <- lm(mental_health_days ~ inequality + college + unempl + mh_providers
                + child_poverty + single_parent + severe_housing + food_index
                + median_inc + hs_grad
                + region + year, data = ranked)
summary(lm_days_3)
xkablevif(lm_days_3)

# v4: include demographic vars
lm_days_4 <- lm(mental_health_days ~ inequality + college + unempl + mh_providers
                + child_poverty + single_parent + severe_housing + food_index
                + median_inc + hs_grad
                + pop + pct_below18 + pct_female + pct_rural
                + pct_black + pct_native_am + pct_asian + pct_pacific + pct_hispanic + pct_white
                + region + year, data = ranked)
summary(lm_days_4)
xkablevif(lm_days_4)

```

```{r lm_vif, results='markup'}

# v5: remove vars to reduce vif
lm_days_5 <- lm(mental_health_days ~ inequality + college + hs_grad + unempl
                + child_poverty + single_parent + severe_housing + food_index
                + pop + pop_provider_ratio + pct_female
                + pct_black + pct_native_am + pct_asian + pct_pacific + pct_hispanic
                + region + year, data = ranked)
summary(lm_days_5)
xkablevif(lm_days_5)

```

### Dependent variable: `mental_distress_rate`


# Model Evaluation and Comparison

```{r anova_lm}

anovaRes_a <- anova(lm_days_1,lm_days_2)
anovaRes_b <- anova(lm_days_3,lm_days_5)

xkabledply(anovaRes_a, title = "ANOVA comparison between two linear models")
xkabledply(anovaRes_b, title = "ANOVA comparison between two linear models")


```



